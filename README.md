# 🚀 Sora批量出图工具 V3.4

> **一键批量生成高质量AI图片的神器工具**
> 支持多平台API，智能参考图匹配，高并发处理，让AI出图变得简单高效！

## 🆕 V3.4 版本更新

### ✨ 新增功能
- **智能选择系统** - 复选框批量选择，支持全选、单选、点击行选择
- **简化图片查看器** - 双击图片打开简洁全屏查看器，专注内容展示
- **历史记录智能去重** - 自动检测重复配置，避免保存相同内容的历史记录
- **enhanced模型支持** - 改进nano-banana模型的响应解析，支持base64格式

### 🔧 优化改进
- **线程安全优化** - 修复UI操作中的线程安全问题，确保界面稳定响应
- **复选框生命周期管理** - 解决表格刷新时的控件删除错误
- **信号连接优化** - 修复lambda闭包问题，确保选择功能正常工作
- **异常处理增强** - 添加全面的错误处理机制，提升程序稳定性

### 🛡️ 安全与架构优化（新增）
- **SSL 安全开关**：默认开启证书校验。在设置中心的「⚡ 生成参数」中提供「允许不安全连接」选项，仅在受信网络或调试时启用。
- **事件循环整合**：接入 `qasync` 将 Qt 与 `asyncio` 合并运行，提升并发稳定性；如未安装依赖会自动回退到原有启动方式。
- **模块化拆分**：新增 `services/` 目录，通用功能下沉：`pathing.py`（路径）、`images.py`（图片与分类工具）、`history.py`（历史记录读写去重）、`api_client.py`（API 请求与响应解析）。
- **数据骨架**：新增 `data/schema.sql`（SQLite 示例结构），为后续素材/任务索引做准备（当前功能不依赖）。

### ⚙️ 默认设置调整（新增）
- 默认模型：`sora_image`
- 并发线程数：默认 `50`
- 批量编辑默认操作：查找替换

## ✨ 核心功能特色

### 🎯 批量智能生成
- **CSV批量导入** - 一次导入几百个提示词，自动批量生成
- **智能生成模式** - 只生成新增的提示词，避免重复工作
- **高速并发处理** - 最高支持1000个并发，大幅提升生成速度
- **失败自动重试** - 网络问题自动重试，确保成功率

### 🖼️ 智能参考图系统
- **分类管理** - 按家庭、角色、场景等分类管理参考图
- **自动匹配** - 在提示词中提到图片名称，自动添加对应参考图
- **本地存储** - 参考图保存在本地，加载速度快
- **全局唯一命名** - 确保图片名称不重复，避免混淆

### 🎨 风格库系统
- **预设风格** - 内置超写实、皮克斯、动漫等多种风格
- **自定义风格** - 创建和保存自己的专属风格模板
- **一键应用** - 选择风格后自动应用到所有提示词
- **风格导入导出** - 分享和备份风格设置

### 🔑 多平台密钥管理
- **多平台支持** - 支持云雾AI、API易、apicore三大平台
- **密钥库管理** - 安全存储多个API密钥，随时切换
- **使用记录** - 自动记录密钥使用时间和平台信息

### 📁 智能文件管理
- **防覆盖保护** - 同名文件自动添加后缀（如：1.png → 1-2.png）
- **实时缩略图** - 生成完成立即显示缩略图预览
- **状态跟踪** - 实时显示等待、生成中、下载中、成功等状态
- **智能选择系统** - 支持复选框批量选择、全选功能、点击行选择
- **批量操作** - 支持选中重新生成、全部重新生成等操作
- **历史记录去重** - 自动检测重复内容，避免保存相同配置的历史记录

### 🖼️ 增强图片查看
- **简化查看器** - 双击图片打开简洁的全屏查看器
- **快速预览** - 只显示图片和关闭按钮，专注内容展示
- **线程安全** - 优化UI响应，确保操作流畅稳定

## 🚀 快速开始指南

### 第一步：基础配置

1. **安装依赖**（推荐使用自带虚拟环境）
   - macOS/Linux：`source venv/bin/activate && pip install -r requirements.txt`
   - Windows（CMD）：`venv\Scripts\activate && pip install -r requirements.txt`
2. **启动程序**：
   - Windows：双击 `sora批量出图启动.bat`
   - macOS：双击 `启动Sora工具.command`
   - 或命令行运行：`python main.py`
2. **点击 "⚙️ 设置中心"** 进入配置界面
3. **配置API密钥**：
   - 在"密钥库"标签页点击"➕ 新建密钥"
   - 输入容易识别的名称（如：我的云雾密钥）
   - 选择对应的API平台
   - 输入完整的API密钥
   - 点击保存
4. **选择密钥**：在"基础配置"标签页选择刚创建的密钥
5. **设置保存路径**：选择图片保存的文件夹
6. **调整参数**：
   - 并发线程数：建议根据API限制设置（1-50）
   - 失败重试次数：建议2-3次
   - 图片比例：选择3:2或2:3
    - 网络安全：默认为安全连接。若遇到证书问题且网络可信，可临时勾选「允许不安全连接」，完成后建议关闭。

### 第二步：准备参考图（可选）

如果需要使用参考图：

1. **创建分类**：
   - 在设置中心的"参考图库"标签页
   - 点击"➕ 新建分类"，如"角色图片"
2. **添加图片**：
   - 选择分类后点击"➕ 批量添加图片"
   - 多选本地图片文件，自动复制到项目目录并生成全局唯一名称
   - 双击名称可直接重命名（同时同步重命名本地文件名）

### 第三步：设置风格（可选）

1. **选择预设风格**：在"风格库"标签页选择喜欢的风格
2. **或创建自定义风格**：
   - 点击"➕ 新建"创建新风格
   - 输入风格描述内容
   - 保存并应用

### 第四步：批量生成图片

#### 方法一：CSV文件批量导入

1. **准备CSV文件**，包含以下列：
   ```csv
   分镜编号,分镜提示词
   001,小明在公园里踢足球
   002,小红在图书馆看书
   003,一家人在餐厅吃饭
   ```

2. **导入文件**：
   - 点击主界面的"📁 导入CSV文件"
   - 选择准备好的CSV文件
   - 确认提示词正确加载

3. **开始生成**：
   - 确认配置无误后点击"🚀 智能生成(仅新增)"
   - 工具会自动处理所有提示词

#### 方法二：手动添加提示词

1. **添加提示词**：
   - 点击"➕ 添加提示词"
   - 输入提示词内容
   - 重复添加多个提示词

2. **开始生成**：点击"🚀 智能生成(仅新增)"

#### 方法三：粘贴导入（新）

1. 点击“📋 粘贴导入”，或直接粘贴（从 Excel/编辑器复制文本/TSV/CSV）
2. 在预览对话框中确认列映射：
   - 编号列：支持“分镜编号/分镜数/编号/number/id”
   - 提示词列：支持“分镜提示词/首帧提示词/提示词/prompt”
3. 可勾选“仅新增（按编号去重）”“忽略空提示词”后确认导入

## 🎯 高级使用技巧

### 智能参考图匹配

在提示词中提到图片名称，工具会自动添加对应的参考图：

```
提示词：小明在公园里踢足球
结果：自动加载名为"小明"的参考图

提示词：小红和小明一起看书  
结果：自动加载"小红"和"小明"两张参考图
```

### 匹配规则（新）
- 采用“边界匹配 + 最长优先遮盖”：
  - 名称按长度降序匹配，先命中更长的名称（如“鲁小二”优先于“鲁二”）
  - 仅在名称左右为“非中英数字”或文本边界时命中，避免子串误判
  - 命中片段会被“遮盖”，后续短名不会再命中同一段文本
- 括号修饰如“小鲁（黑色头发，衣服破旧）”可稳定命中“小鲁”（修饰不影响匹配）

### 批量重新生成

- **智能选择**：使用复选框系统进行精确选择
  - 点击表头复选框实现全选/取消全选
  - 点击行内复选框选择单个项目
  - 点击表格行任意位置也可选中该行
- **重新生成选中**：选中特定提示词，点击"🔄 重新生成选中"
- **重新生成全部**：点击"🔄 重新生成全部"重新生成所有图片

### 风格应用

在主界面选择风格后，所有提示词都会自动应用该风格：
- 选择"超写实风格" → 所有图片都将是写实风格
- 选择"皮克斯风格" → 所有图片都将是动画风格

### 编辑功能

- **编辑提示词**：双击提示词内容可以修改
- **编辑编号**：单击编号可以修改
- **删除操作**：选中后点击"🗑️ 删除选中"
- **图片查看**：双击缩略图打开简洁的全屏查看器

## 📊 状态说明

| 状态 | 说明 |
|------|------|
| 等待中 | 提示词已添加，等待生成 |
| 生成中 | 正在调用API生成图片 |
| 下载中 | 图片生成完成，正在下载 |
| ✅ 成功 | 图片生成并下载完成 |
| ❌ 失败 | 生成失败，查看错误信息 |

## 💡 使用提示

### 提升成功率
- **API密钥确保有效** 且有足够额度
- **网络连接稳定**，避免频繁断网
- **并发数不要过高**，避免API限流
- **提示词描述清晰**，避免违规内容

### 提升效率
- **使用CSV批量导入** 处理大量提示词
- **合理设置并发数**（建议10-50个）
- **提前准备参考图** 和风格设置
- **定期保存配置** 避免重复设置

### 文件管理
- **定期清理图片文件夹** 避免文件过多
- **备份重要的风格设置** 使用导出功能
- **重要图片及时转移** 到其他位置保存

## ❓ 常见问题

**Q：为什么显示"API密钥不能为空"？**  
A：请在设置中心的密钥库中添加有效的API密钥并选择。

**Q：为什么一直显示"生成中"？**  
A：可能是网络问题或API平台繁忙，请检查网络连接和API额度。

**Q：提示证书验证失败/网络错误？**  
A：先检查系统时间与网络环境；必要时在设置中心启用「允许不安全连接」，用于临时绕过证书校验（受信网络下）。

**Q：启动报错 `qasync` 未找到？**  
A：请先激活虚拟环境并安装依赖：`pip install -r requirements.txt`。未安装时程序会回退到旧的事件循环方式。

**Q：如何管理大量图片与历史？**  
A：当前历史以 JSON 保存；项目提供了 `data/schema.sql` 作为后续升级到 SQLite 的参考结构。

**Q：参考图为什么没有自动加载？**  
A：确保提示词中包含完整的图片名称，且图片名称在系统中是唯一的。

**Q：如何避免图片被覆盖？**  
A：工具已自动处理，同名图片会添加后缀（如1-2.png）。

**Q：可以同时使用多个API平台吗？**  
A：可以在密钥库中添加多个平台的密钥，但同一时间只能使用一个。

---

**享受AI批量出图的乐趣吧！🎉** 
